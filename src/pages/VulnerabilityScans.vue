<template>
  <div class="q-px-lg mb-5" style="width: 100%">
    <div class="flex flex-col sm:flex-row justify-start mb-[-1rem]">
      <q-btn
        color="primary"
        label="New Vulnerability Scan"
        icon="add"
        no-caps
        href="https://crm.aislabs.com/ais-vulnerability-scan"
        target="_blank"
      />

      <q-input
        v-model="state.search"
        :dense="true"
        :dark="darkmode"
        filled
        label="Search Vulnerability Scans"
        class="implementation-search relative w-60 mt-4 sm:mt-0 sm:absolute sm:right-5 mr-1"
      >
        <template #append>
          <q-icon
            :name="state.search === '' ? 'search' : 'close'"
            class="cursor-pointer"
            @click="state.search = ''"
          />
        </template>
      </q-input>
    </div>

    <ListQTable
      :rows="vulnerabilityScans"
      :columns="columns"
      :stateValue="state"
      title="Vulnerability Scans"
      :handleRowClick="handleRowClick"
      :setPage="setPage"
      customNoDataText="Searching for Vulnerability Scans..."
      :loading="state.searchLoading"
      :showPagination="false"
    />
  </div>
</template>

<script>
import { defineComponent, reactive, watchEffect, ref, watch, inject, computed } from "vue";
import { useQuery } from "@vue/apollo-composable";
import { useRouter } from "vue-router";
import { useQuasar } from "quasar";
import ListQTable from "src/components/reusables/tables/ListQTable.vue";
import { VulnerabilityScansQuery } from "src/graphql/query/VulnerabilityScan.js";
import { useDarkModeStore } from "src/stores/dark-mode.js";

export default defineComponent({
  name: "VulnerabilityScans",
  components: { ListQTable },
  setup() {
    const state = reactive({
      search: "",
      totalPages: 3,
      page: 1,
      searchLoading: true,
    });

    const darkmode = computed(() => useDarkModeStore().darkmode);

    const $q = useQuasar();
    function loadingScreen(routeName) {
      $q.loading.show({
        message: "Redirecting to Implementation: " + routeName,
      });
      setTimeout(() => {
        $q.loading.hide();
      }, 1000);
    }

    watch(
      () => state.search,
      () => {
        state.searchLoading = true;
      },
      { immediate: true }
    );

    const route = useRouter();
    function goToImplementation(item) {
      loadingScreen(item.Name);
      route.push({
        path: "/implementation-preview",
        query: { id: item.id },
      });
    }

    const handleRowClick = (id, row, evt) => {
      console.log("open", evt);
      if (evt.ctrlKey || evt.button === 1 || evt === "openNewTab") {
        window.open(`vulnerability-scan-details/${id}`, "_blank");
      } else if (evt === "openNewWindow") {
        window.open(
          `vulnerability-scan-details/${id}`,
          "_blank",
          "width=full,height=full"
        );
      } else if (evt === "openIncognitoWindow") {
        window.open(`vulnerability-scan-details/${id}`, "_blank", "incognito=yes");
      } else if (evt.button !== 2) {
        route.push({ name: "Vulnerability Scan Details", params: { id: id } });
      }
    };

    const columns = reactive([
      {
        name: "accountID",
        align: "left",
        label: "Account ID",
        field: (row) => row.account_id,
        format: (val) => `${val}`,
        sortable: true,
        dense: true,
      },
      {
        name: "name",
        align: "left",
        label: "Domain Name",
        field: (row) => row.DomainName,
        format: (val) => `${val}`,
        sortable: true,
      },
      {
        name: "LastReportDate",
        align: "center",
        label: "Last Report Date",
        field: (row) => row.LastReportDate ?? "N/A",
        format: (val) => `${val}`,
        sortable: true,
      },
      {
        name: "complete",
        align: "center",
        label: "Complete (%)",
        field: (row) => (row.ScanStatusPercent ?? 0) + "%",
        format: (val) => `${val}`,
        sortable: true,
      },
      {
        name: "DiscoveryCompleted",
        align: "center",
        label: "Discovery Completed",
        field: (row) => (row.discoveryCompleted ? "Yes" : "No"),
        format: (val) => `${val}`,
        sortable: true,
      },
      {
        name: "actions",
        align: "center",
        label: "Actions",
      },
    ]);

    function setPage(page) {
      state.page = page;
    }

    const { result: scans } = useQuery(VulnerabilityScansQuery, () => ({
      page: state.page,
      DomainName: state.search,
      first: 100,
    }));

    const vulnerabilityScans = ref([]);
    watchEffect(() => {
      if (scans.value) {
        vulnerabilityScans.value = scans.value.VulnerabilityScans.data;
        state.searchLoading = false;
        // state.totalPages = scans.value.VulnerabilityScans.paginatorInfo.total;
      }
    });

    const windowWidth = inject("windowWidth");

    const updateColumns = () => {
      if (windowWidth.value <= 900) {
        const statusColumnIndex = columns.findIndex(
          (column) => column.name === "complete"
        );
        if (statusColumnIndex !== -1) {
          columns.splice(statusColumnIndex, 1);
        }
      } else {
        const statusColumn = columns.find((column) => column.name === "complete");
        if (!statusColumn) {
          columns.splice(2, 0, {
            name: "complete",
            align: "center",
            label: "Complete (%)",
            field: (row) => (row.ScanStatusPercent ?? 0) + "%",
            format: (val) => `${val}`,
            sortable: true,
          });
        }
      }
      if (windowWidth.value <= 750) {
        const poColumnIndex = columns.findIndex(
          (column) => column.name === "LastReportDate"
        );
        if (poColumnIndex !== -1) {
          columns.splice(poColumnIndex, 1);
        }
      } else {
        const poColumn = columns.find((column) => column.name === "LastReportDate");
        if (!poColumn) {
          columns.splice(2, 0, {
            name: "LastReportDate",
            align: "center",
            label: "Last Report Date",
            field: (row) => row.LastReportDate ?? "N/A",
            format: (val) => `${val}`,
            sortable: true,
          });
        }
      }
      if (windowWidth.value <= 500) {
        const idIndex = columns.findIndex(
          (column) => column.name === "DiscoveryCompleted"
        );
        if (idIndex !== -1) {
          columns.splice(idIndex, 1);
        }
      } else {
        const idColumn = columns.find((column) => column.name === "DiscoveryCompleted");
        if (!idColumn) {
          columns.splice(1, 0, {
            name: "DiscoveryCompleted",
            align: "center",
            label: "Discovery Completed",
            field: (row) => (row.discoveryCompleted ? "Yes" : "No"),
            format: (val) => `${val}`,
            sortable: true,
          });
        }
      }
      if (windowWidth.value <= 600) {
        const idIndex = columns.findIndex((column) => column.name === "accountID");
        if (idIndex !== -1) {
          columns.splice(idIndex, 1);
        }
      } else {
        const idColumn = columns.find((column) => column.name === "accountID");
        if (!idColumn) {
          columns.splice(0, 0, {
            name: "accountID",
            align: "left",
            label: "Account ID",
            field: (row) => row.account_id,
            format: (val) => `${val}`,
            sortable: true,
            dense: true,
          });
        }
      }
    };

    watch(
      () => windowWidth.value,
      () => {
        updateColumns();
      },
      { immediate: true }
    );

    return {
      state,
      goToImplementation,
      columns,
      handleRowClick,
      setPage,
      vulnerabilityScans,
      darkmode,
    };
  },
});
</script>
